function [dzdt,dfdz,dfdp] = lygerosMagic(z,u,p)
%model from lygeros paper with full tire model
%states
x=z(1);
y=z(2);
psi=z(3);
vy=z(4);
w=z(5);

%inputs
d=u(1);
vx=u(2);

%parameters
%p = [m,Iz,lf,l,Bf,Cf,Df,p1,p2]';
scale=[1,.1,.1,.1,1,1,1,.001,.001];
m=p(1)*scale(1); %mass
Iz=p(2)*scale(2); %moment of inertia
lf=p(3)*scale(3); %length of center of mass from front
l=p(4)*scale(4); %length of wheelbase
Bf=p(5)*scale(5); %front tire coefficient 1
Cf=p(6)*scale(6);%front tire coefficient 2
Df=p(7)*scale(7);%front tire coefficient 3
p1=p(8)*scale(8);%scaling for steering input
p2=p(9)*scale(9);%scaling for steering input



dzdt=[vx*cos(psi) - vy*sin(psi)
                                                                                                                                                                 vy*cos(psi) + vx*sin(psi);...
                                                                                                                                                                                         w;...
 Df*sin(Cf*atan(Bf*(p2 - atan((vy + (l*w)/2)/vx) + d*p1)))*cos(p2 + d*p1)*(1/m + (lf*(l/2 - lf))/Iz) - Df*sin(Cf*atan(Bf*atan((vy - (l*w)/2)/vx)))*(1/m - ((l - lf)*(l/2 - lf))/Iz) - vx*w;...
                                                   (Df*sin(Cf*atan(Bf*atan((vy - (l*w)/2)/vx)))*(l - lf) + Df*lf*sin(Cf*atan(Bf*(p2 - atan((vy + (l*w)/2)/vx) + d*p1)))*cos(p2 + d*p1))/Iz];
 
                                                   
                                                   
dfdz=[ 0, 0, - vy*cos(psi) - vx*sin(psi),                                                                                                                                                                                                                                                                                                                                                      -sin(psi),                                                                                                                                                                                                                                                                                                                                                                         0;...
 0, 0,   vx*cos(psi) - vy*sin(psi),                                                                                                                                                                                                                                                                                                                                                       cos(psi),                                                                                                                                                                                                                                                                                                                                                                         0;...
 0, 0,                           0,                                                                                                                                                                                                                                                                                                                                                              0,                                                                                                                                                                                                                                                                                                                                                                         1;...
 0, 0,                           0, - (Bf*Cf*Df*cos(Cf*atan(Bf*atan((vy - (l*w)/2)/vx)))*(1/m - ((l - lf)*(l/2 - lf))/Iz))/(vx*((vy - (l*w)/2)^2/vx^2 + 1)*(Bf^2*atan((vy - (l*w)/2)/vx)^2 + 1)) - (Bf*Cf*Df*cos(Cf*atan(Bf*(p2 - atan((vy + (l*w)/2)/vx) + d*p1)))*cos(p2 + d*p1)*(1/m + (lf*(l/2 - lf))/Iz))/(vx*((vy + (l*w)/2)^2/vx^2 + 1)*(Bf^2*(p2 - atan((vy + (l*w)/2)/vx) + d*p1)^2 + 1)), (Bf*Cf*Df*l*cos(Cf*atan(Bf*atan((vy - (l*w)/2)/vx)))*(1/m - ((l - lf)*(l/2 - lf))/Iz))/(2*vx*((vy - (l*w)/2)^2/vx^2 + 1)*(Bf^2*atan((vy - (l*w)/2)/vx)^2 + 1)) - vx - (Bf*Cf*Df*l*cos(Cf*atan(Bf*(p2 - atan((vy + (l*w)/2)/vx) + d*p1)))*cos(p2 + d*p1)*(1/m + (lf*(l/2 - lf))/Iz))/(2*vx*((vy + (l*w)/2)^2/vx^2 + 1)*(Bf^2*(p2 - atan((vy + (l*w)/2)/vx) + d*p1)^2 + 1));...
 0, 0,                           0,                                              ((Bf*Cf*Df*cos(Cf*atan(Bf*atan((vy - (l*w)/2)/vx)))*(l - lf))/(vx*((vy - (l*w)/2)^2/vx^2 + 1)*(Bf^2*atan((vy - (l*w)/2)/vx)^2 + 1)) - (Bf*Cf*Df*lf*cos(Cf*atan(Bf*(p2 - atan((vy + (l*w)/2)/vx) + d*p1)))*cos(p2 + d*p1))/(vx*((vy + (l*w)/2)^2/vx^2 + 1)*(Bf^2*(p2 - atan((vy + (l*w)/2)/vx) + d*p1)^2 + 1)))/Iz,                                                -((Bf*Cf*Df*l*cos(Cf*atan(Bf*atan((vy - (l*w)/2)/vx)))*(l - lf))/(2*vx*((vy - (l*w)/2)^2/vx^2 + 1)*(Bf^2*atan((vy - (l*w)/2)/vx)^2 + 1)) + (Bf*Cf*Df*l*lf*cos(Cf*atan(Bf*(p2 - atan((vy + (l*w)/2)/vx) + d*p1)))*cos(p2 + d*p1))/(2*vx*((vy + (l*w)/2)^2/vx^2 + 1)*(Bf^2*(p2 - atan((vy + (l*w)/2)/vx) + d*p1)^2 + 1)))/Iz];
 
 


dfdp=[                                                                                                                                  0,                                                                                                                                                                        0,                                                                                                                                                                0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           0,                                                                                                                                                                                                                                                                                                                                                  0,                                                                                                                                                                                                                                                                  0,                                                                                                                                                                            0,                                                                                                                                                                                                                                                                        0,                                                                                                                                                                                                                                                                    0;...
                                                                                                                                  0,                                                                                                                                                                        0,                                                                                                                                                                0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           0,                                                                                                                                                                                                                                                                                                                                                  0,                                                                                                                                                                                                                                                                  0,                                                                                                                                                                            0,                                                                                                                                                                                                                                                                        0,                                                                                                                                                                                                                                                                    0;...
                                                                                                                                  0,                                                                                                                                                                        0,                                                                                                                                                                0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           0,                                                                                                                                                                                                                                                                                                                                                  0,                                                                                                                                                                                                                                                                  0,                                                                                                                                                                            0,                                                                                                                                                                                                                                                                        0,                                                                                                                                                                                                                                                                    0;...
 (Df*sin(Cf*atan(Bf*atan((vy - (l*w)/2)/vx))))/m^2 - (Df*sin(Cf*atan(Bf*(p2 - atan((vy + (l*w)/2)/vx) + d*p1)))*cos(p2 + d*p1))/m^2, - (Df*sin(Cf*atan(Bf*atan((vy - (l*w)/2)/vx)))*(l - lf)*(l/2 - lf))/Iz^2 - (Df*lf*sin(Cf*atan(Bf*(p2 - atan((vy + (l*w)/2)/vx) + d*p1)))*cos(p2 + d*p1)*(l/2 - lf))/Iz^2, (Df*sin(Cf*atan(Bf*(p2 - atan((vy + (l*w)/2)/vx) + d*p1)))*cos(p2 + d*p1)*(l - 4*lf))/(2*Iz) - (Df*sin(Cf*atan(Bf*atan((vy - (l*w)/2)/vx)))*(3*l - 4*lf))/(2*Iz), Df*sin(Cf*atan(Bf*atan((vy - (l*w)/2)/vx)))*((l - lf)/(2*Iz) + (l/2 - lf)/Iz) + (Df*lf*sin(Cf*atan(Bf*(p2 - atan((vy + (l*w)/2)/vx) + d*p1)))*cos(p2 + d*p1))/(2*Iz) + (Bf*Cf*Df*w*cos(Cf*atan(Bf*atan((vy - (l*w)/2)/vx)))*(1/m - ((l - lf)*(l/2 - lf))/Iz))/(2*vx*((vy - (l*w)/2)^2/vx^2 + 1)*(Bf^2*atan((vy - (l*w)/2)/vx)^2 + 1)) - (Bf*Cf*Df*w*cos(Cf*atan(Bf*(p2 - atan((vy + (l*w)/2)/vx) + d*p1)))*cos(p2 + d*p1)*(1/m + (lf*(l/2 - lf))/Iz))/(2*vx*((vy + (l*w)/2)^2/vx^2 + 1)*(Bf^2*(p2 - atan((vy + (l*w)/2)/vx) + d*p1)^2 + 1)), (Cf*Df*cos(Cf*atan(Bf*(p2 - atan((vy + (l*w)/2)/vx) + d*p1)))*cos(p2 + d*p1)*(1/m + (lf*(l/2 - lf))/Iz)*(p2 - atan((vy + (l*w)/2)/vx) + d*p1))/(Bf^2*(p2 - atan((vy + (l*w)/2)/vx) + d*p1)^2 + 1) - (Cf*Df*atan((vy - (l*w)/2)/vx)*cos(Cf*atan(Bf*atan((vy - (l*w)/2)/vx)))*(1/m - ((l - lf)*(l/2 - lf))/Iz))/(Bf^2*atan((vy - (l*w)/2)/vx)^2 + 1), Df*atan(Bf*(p2 - atan((vy + (l*w)/2)/vx) + d*p1))*cos(Cf*atan(Bf*(p2 - atan((vy + (l*w)/2)/vx) + d*p1)))*cos(p2 + d*p1)*(1/m + (lf*(l/2 - lf))/Iz) - Df*atan(Bf*atan((vy - (l*w)/2)/vx))*cos(Cf*atan(Bf*atan((vy - (l*w)/2)/vx)))*(1/m - ((l - lf)*(l/2 - lf))/Iz), sin(Cf*atan(Bf*(p2 - atan((vy + (l*w)/2)/vx) + d*p1)))*cos(p2 + d*p1)*(1/m + (lf*(l/2 - lf))/Iz) - sin(Cf*atan(Bf*atan((vy - (l*w)/2)/vx)))*(1/m - ((l - lf)*(l/2 - lf))/Iz), (Bf*Cf*Df*d*cos(Cf*atan(Bf*(p2 - atan((vy + (l*w)/2)/vx) + d*p1)))*cos(p2 + d*p1)*(1/m + (lf*(l/2 - lf))/Iz))/(Bf^2*(p2 - atan((vy + (l*w)/2)/vx) + d*p1)^2 + 1) - Df*d*sin(Cf*atan(Bf*(p2 - atan((vy + (l*w)/2)/vx) + d*p1)))*sin(p2 + d*p1)*(1/m + (lf*(l/2 - lf))/Iz), (Bf*Cf*Df*cos(Cf*atan(Bf*(p2 - atan((vy + (l*w)/2)/vx) + d*p1)))*cos(p2 + d*p1)*(1/m + (lf*(l/2 - lf))/Iz))/(Bf^2*(p2 - atan((vy + (l*w)/2)/vx) + d*p1)^2 + 1) - Df*sin(Cf*atan(Bf*(p2 - atan((vy + (l*w)/2)/vx) + d*p1)))*sin(p2 + d*p1)*(1/m + (lf*(l/2 - lf))/Iz);...
                                                                                                                                  0,                               -(Df*sin(Cf*atan(Bf*atan((vy - (l*w)/2)/vx)))*(l - lf) + Df*lf*sin(Cf*atan(Bf*(p2 - atan((vy + (l*w)/2)/vx) + d*p1)))*cos(p2 + d*p1))/Iz^2,                                      -(Df*(sin(Cf*atan(Bf*atan((vy - (l*w)/2)/vx))) - sin(Cf*atan(Bf*(p2 - atan((vy + (l*w)/2)/vx) + d*p1)))*cos(p2 + d*p1)))/Iz,                                                                                                                                                                    -((Bf*Cf*Df*w*cos(Cf*atan(Bf*atan((vy - (l*w)/2)/vx)))*(l - lf))/(2*vx*((vy - (l*w)/2)^2/vx^2 + 1)*(Bf^2*atan((vy - (l*w)/2)/vx)^2 + 1)) - Df*sin(Cf*atan(Bf*atan((vy - (l*w)/2)/vx))) + (Bf*Cf*Df*lf*w*cos(Cf*atan(Bf*(p2 - atan((vy + (l*w)/2)/vx) + d*p1)))*cos(p2 + d*p1))/(2*vx*((vy + (l*w)/2)^2/vx^2 + 1)*(Bf^2*(p2 - atan((vy + (l*w)/2)/vx) + d*p1)^2 + 1)))/Iz,                                            ((Cf*Df*atan((vy - (l*w)/2)/vx)*cos(Cf*atan(Bf*atan((vy - (l*w)/2)/vx)))*(l - lf))/(Bf^2*atan((vy - (l*w)/2)/vx)^2 + 1) + (Cf*Df*lf*cos(Cf*atan(Bf*(p2 - atan((vy + (l*w)/2)/vx) + d*p1)))*cos(p2 + d*p1)*(p2 - atan((vy + (l*w)/2)/vx) + d*p1))/(Bf^2*(p2 - atan((vy + (l*w)/2)/vx) + d*p1)^2 + 1))/Iz,                                            (Df*atan(Bf*atan((vy - (l*w)/2)/vx))*cos(Cf*atan(Bf*atan((vy - (l*w)/2)/vx)))*(l - lf) + Df*lf*atan(Bf*(p2 - atan((vy + (l*w)/2)/vx) + d*p1))*cos(Cf*atan(Bf*(p2 - atan((vy + (l*w)/2)/vx) + d*p1)))*cos(p2 + d*p1))/Iz,                                            (sin(Cf*atan(Bf*atan((vy - (l*w)/2)/vx)))*(l - lf) + lf*sin(Cf*atan(Bf*(p2 - atan((vy + (l*w)/2)/vx) + d*p1)))*cos(p2 + d*p1))/Iz,                                           -(Df*d*lf*sin(Cf*atan(Bf*(p2 - atan((vy + (l*w)/2)/vx) + d*p1)))*sin(p2 + d*p1) - (Bf*Cf*Df*d*lf*cos(Cf*atan(Bf*(p2 - atan((vy + (l*w)/2)/vx) + d*p1)))*cos(p2 + d*p1))/(Bf^2*(p2 - atan((vy + (l*w)/2)/vx) + d*p1)^2 + 1))/Iz,                                           -(Df*lf*sin(Cf*atan(Bf*(p2 - atan((vy + (l*w)/2)/vx) + d*p1)))*sin(p2 + d*p1) - (Bf*Cf*Df*lf*cos(Cf*atan(Bf*(p2 - atan((vy + (l*w)/2)/vx) + d*p1)))*cos(p2 + d*p1))/(Bf^2*(p2 - atan((vy + (l*w)/2)/vx) + d*p1)^2 + 1))/Iz];

 %add scaling to jacobian for parameters 
  scale=repmat(scale,5,1);
  dfdp=scale.*dfdp;
end

